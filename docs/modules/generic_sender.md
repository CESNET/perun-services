# Generic Send (generic_sender.py)

## Description

This script sends data (e.g. generated by the [PerunDataGenerator](PerunDataGenerator.md)) using API call, ssh or tar command. It is
used by the sending scripts (written in python/bash/perl etc.) by some services.

Generally the script first does some input validation, determines the destination type and uses the transport method
specific for that destination type (as described below).

## Usage based on the destination type

### URL
This destination type sends the data to the API using the curl command. The data is g-zipped and then sent in the body of the request. The script sends the data using 'POST' method. Adds common Perun certificate, if it is available.

### HOST, USER@HOST, USER@HOST:PORT, USER@HOST-WINDOWS, HOST-WINDOWS-PROXY
This destination type sends the data to the target machine using the ssh command. The data is g-zipped and then sent to the target machine.

### S3
This destination type sends the data to target S3 bucket using boto3 library. The data is g-zipped and then sent to 
the bucket as <facility-name>/<g-zipped archive>.

Access key and secret key must be configured in the service configuration file at
`/etc/perun/services/{service_name}/{service_name}.py` file.

Additionally, the following can also be specified in this file:

- filename_extension
  - if `True`, the uploaded file's name will be by default extended by date&time
  - the exact format of the extension can be set by the `extension_format` config option
- extension_format
  - modifies the format of `filename_extension` if it is set to true.
  - The content should be a string which is then parsable by `datetime.strftime()`, e.g. '%Y-%m-%d'
- url_endpoint
  - url endpoint to be called after the upload to S3 has been completed
- auth_type
  - selects authentication type for the url_endpoint, if needed
  - accepts `basic` or `bearer`, any other value behaves as if there was no auth_type
- credentials
  - credentials for the selected `auth_type`
  - expected format for `basic`:
    - `'credentials': { 'username': "<ba-username>", 'password': "<ba-password>" }`
  - expected format for `bearer`:
    - `'credentials': { 'token': "<bearer-token>" }`

Example of such file, where `<S3-bucket-address>` is in the format of `{endpoint_url}/{bucket_name}`:

    credentials = {
    "<S3-bucket-address>": { 'access_key': "<key>", 'secret_key': "<key>",
    'filename_extension': True/False, 'url_endpoint': "<url>", 
    'auth_type': "basic", 'credentials': { 'username': "<ba-username>", 'password': "<ba-password>" } }
    }

### URL-JSON
Extension of the URL destination type.

This destination type also sends the data to the API using a curl command.
It only sends a single JSON file in the body of the request, if such file has been generated by the gen script.
If there is no JSON file or more than one, the script raises an error.

For now, this destination type can only be used with `generic_json_gen` script

### S3-JSON
Extension of the S3 destination type.

This destination type sends a single JSON file to target S3 bucket instead of g-zipped archive of the entire
generated data.

Configuration is the same as with the S3 destination type. Access key and secret key must be configured, while all
the other optional parameters can also be set. Path to the configuration file is the same: `/etc/perun/services/{service_name}/{service_name}.py`


### Unsupported destination types
The following destination types are not supported yet:
- `email`
- `service-specific`




